<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>HOROLOGY.IA Terminal</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#020617;
  color:#e5e7eb;
  min-height:100vh;
  padding:24px;
}
.container{
  max-width:1250px;
  margin:0 auto;
  background:#020617;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.logo{
  display:flex;
  align-items:center;
  gap:10px;
}
.logo-title{
  font-size:28px;
  font-weight:800;
  letter-spacing:1px;
}
.logo-accent{color:#22c55e}
.tagline{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.12em;
  color:#9ca3af;
}
.badge{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  background:#022c22;
  color:#6ee7b7;
  border:1px solid #065f46;
  cursor:pointer;
  transition:all 0.2s;
}
.badge:hover{
  background:#065f46;
  color:#d1fae5;
}

.ticker{
  margin-top:6px;
  font-size:11px;
  color:#9ca3af;
  font-family:"SF Mono","Menlo",monospace;
}
.grid-main{
  display:grid;
  grid-template-columns:330px minmax(0,1fr);
  gap:18px;
  transition:all 0.3s ease;
}
.grid-main.presentation-mode{
  grid-template-columns:0 minmax(0,1fr);
}
.grid-main.presentation-mode .panel:first-child{
  opacity:0;
  pointer-events:none;
  width:0;
  padding:0;
  overflow:hidden;
}

.panel{
  background:radial-gradient(circle at top left,#020617 0,#020617 40%,#0b1120 100%);
  border-radius:12px;
  border:1px solid #1f2937;
  padding:16px 18px;
  box-shadow:0 18px 35px rgba(0,0,0,0.7);
}
.panel h3{
  font-size:13px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.14em;
  color:#9ca3af;
  margin-bottom:12px;
}
.form-group{margin-bottom:14px;font-size:13px}
label{display:block;margin-bottom:4px;color:#9ca3af}
input,select{
  width:100%;
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #374151;
  background:#020617;
  color:#e5e7eb;
  font-size:13px;
}
input:focus,select:focus{
  outline:none;
  border-color:#22c55e;
  box-shadow:0 0 0 1px #22c55e55;
}
.checkbox-row{
  display:flex;
  gap:16px;
  font-size:12px;
  color:#e5e7eb;
}
button{
  width:100%;
  margin-top:8px;
  padding:10px;
  border-radius:6px;
  border:none;
  background:linear-gradient(90deg,#22c55e,#16a34a);
  color:#01100a;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
  box-shadow:0 14px 30px rgba(16,185,129,0.35);
}
button:hover{filter:brightness(1.05)}

.resultado{
  display:none;
  margin-top:4px;
  opacity:0;
  animation:fadeIn 0.5s ease forwards;
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

.top-strip{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-bottom:10px;
}
.price-block{font-family:"SF Mono","Menlo",monospace;}
.price-label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.16em;
  color:#9ca3af;
}
.price-value{
  font-size:32px;
  font-weight:700;
  color:#facc15;
}
.range-text{
  font-size:12px;
  color:#9ca3af;
  text-align:right;
}
.stats-row{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:10px;
  margin-top:10px;
}
.stat{
  padding:8px 10px;
  border-radius:8px;
  background:rgba(15,23,42,0.9);
  border:1px solid #1f2937;
}
.stat-label{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.14em;
  color:#6b7280;
}
.stat-value{
  margin-top:3px;
  font-size:14px;
  font-family:"SF Mono","Menlo",monospace;
}
.stat-value.green{color:#4ade80}
.stat-value.red{color:#f97373}

.subgrid{
  display:grid;
  grid-template-columns:minmax(0,1.2fr) minmax(0,1fr);
  gap:14px;
  margin-top:14px;
}
.box{
  background:rgba(15,23,42,0.9);
  border-radius:10px;
  border:1px solid #1f2937;
  padding:10px 12px;
}
.box h4{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.12em;
  color:#9ca3af;
  margin-bottom:8px;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:11px;
}
th,td{
  padding:4px 3px;
  text-align:right;
}
th{
  color:#9ca3af;
  border-bottom:1px solid #1f2937;
  font-weight:500;
}
td:first-child,th:first-child{text-align:left}
tr:nth-child(even){background:rgba(15,23,42,0.6);}
#explicacion{
  margin-top:10px;
  font-size:12px;
  color:#9ca3af;
  line-height:1.5;
}

/* Historial */
.history-box{
  margin-top:14px;
}
.history-table{
  width:100%;
  border-collapse:collapse;
  font-size:11px;
}
.history-table th,.history-table td{
  padding:3px 4px;
}
.history-table th{
  color:#9ca3af;
  border-bottom:1px solid #1f2937;
  font-weight:500;
}
.history-table tr:nth-child(even){
  background:rgba(15,23,42,0.7);
}
.history-title{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.12em;
  color:#9ca3af;
  margin-bottom:4px;
}

/* Escenarios */
.scenario-table{
  width:100%;
  border-collapse:collapse;
  font-size:11px;
}
.scenario-table th,.scenario-table td{
  padding:3px 4px;
}
.scenario-table th{
  color:#9ca3af;
  border-bottom:1px solid #1f2937;
}
.scenario-table tr:nth-child(even){
  background:rgba(15,23,42,0.7);
}
.model-info{
  margin-top:14px;
  padding:10px 12px;
  background:rgba(15,23,42,0.7);
  border-radius:8px;
  border:1px solid #1f2937;
  font-size:11px;
  color:#9ca3af;
  line-height:1.6;
  display:none;
}
.model-info-title{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.12em;
  color:#6b7280;
  margin-bottom:6px;
}
.model-info-title{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.12em;
  color:#6b7280;
  margin-bottom:6px;
}

/* Modo comparaci√≥n */
.comparison-better{
  color:#4ade80 !important;
}
.comparison-worse{
  color:#f97373 !important;
}

.comparison-divider{
  width:1px;
  background:#374151;
}
.comparison-col{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.comparison-header{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.12em;
  color:#9ca3af;
  margin-bottom:8px;
  text-align:center;
}
.comparison-better{
  color:#4ade80 !important;
}
.comparison-worse{
  color:#f97373 !important;
}

/* Tooltips */
.tooltip-icon{
  display:inline-block;
  margin-left:4px;
  width:12px;
  height:12px;
  background:#374151;
  color:#9ca3af;
  border-radius:50%;
  font-size:9px;
  line-height:12px;
  text-align:center;
  cursor:help;
  position:relative;
}
.tooltip-icon:hover::after{
  content:attr(data-tip);
  position:absolute;
  bottom:calc(100% + 5px);
  left:50%;
  transform:translateX(-50%);
  background:#1f2937;
  color:#e5e7eb;
  padding:6px 10px;
  border-radius:6px;
  font-size:11px;
  white-space:nowrap;
  z-index:1000;
  border:1px solid #374151;
  box-shadow:0 4px 12px rgba(0,0,0,0.5);
}

@media(max-width:900px){
  .grid-main{grid-template-columns:1fr}
}

</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="logo">
        <div class="logo-title">HOROLOGY<span class="logo-accent">.IA</span></div>
        <div class="tagline">ROLEX PRICING TERMINAL</div>
      </div>
      <div class="ticker" id="ticker">MODEL: - | FAIR VALUE: - | PREMIUM: -</div>
    </div>
    <div class="badge" id="togglePresentation">PRESENTATION MODE</div>

  </div>

 <div class="grid-main" id="gridMain">

    <!-- PANEL IZQUIERDO -->
    <div class="panel">
      <h3>WATCH INPUT</h3>
      <form id="form">
<div class="form-group">
  <label>Modelo</label>
  <input type="text" id="modeloSearch" placeholder="Buscar modelo..." style="margin-bottom:8px">
  <select id="modelo" required></select>
</div>

        <div class="form-group">
          <label>A√±o</label>
          <input type="number" id="anio" min="1950" max="2026" required>
        </div>
        <div class="form-group">
          <label>Estado</label>
          <select id="estado" required>
            <option value="Unworn">Como nuevo</option>
            <option value="Very good">Muy bueno</option>
            <option value="Good">Bueno</option>
            <option value="Fair">Aceptable</option>
          </select>
        </div>
        <div class="form-group">
          <label>Material</label>
          <select id="material" required>
            <option value="Steel">Acero</option>
            <option value="Yellow gold">Oro amarillo</option>
            <option value="White gold">Oro blanco</option>
            <option value="Rose gold">Oro rosa</option>
            <option value="Gold/Steel">Bicolor</option>
          </select>
        </div>
        <div class="form-group checkbox-row">
          <label><input type="checkbox" id="caja"> Caja</label>
          <label><input type="checkbox" id="papeles"> Papeles</label>
        </div>
        <button type="submit">RUN VALUATION</button>
      </form>
 <div class="model-info" id="modelInfo"></div>
      <!-- HISTORIAL -->
      <div class="history-box">
        <div class="history-title">LAST VALUATIONS</div>
        <table class="history-table" id="tabla_historial">
          <thead>
            <tr>
              <th>Modelo</th>
              <th>A√±o</th>
              <th>Estado</th>
              <th>FV (‚Ç¨)</th>
              <th>% vs media</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- PANEL DERECHO -->
    <div class="panel">
      <h3>VALUATION OUTPUT</h3>
      <div id="resultado" class="resultado">
        <div class="top-strip">
          <div class="price-block">
            <div class="price-label">FAIR VALUE</div>
            <div class="price-value" id="precio"></div>
          </div>
          <div class="range-text" id="rango"></div>
        </div>
</div>

<button id="btnCompare" style="width:auto;padding:8px 16px;margin:10px 0;font-size:12px">
  + ADD TO COMPARISON
</button>

<button id="btnCopy" style="width:auto;padding:8px 16px;margin:10px 0 10px 10px;font-size:12px;background:#2563eb">
  üìã COPY RESULTS
</button>

        <div class="stats-row">
          <div class="stat">
            <div class="stat-label">Precio base<span class="tooltip-icon" data-tip="Precio sin caja ni papeles originales">?</span></div>
            <div class="stat-value" id="base"></div>
          </div>
          <div class="stat">
            <div class="stat-label">Media modelo<span class="tooltip-icon" data-tip="Precio promedio hist√≥rico de este modelo">?</span></div>
            <div class="stat-value" id="media_modelo"></div>
          </div>
          <div class="stat">
            <div class="stat-label">Min - Max dataset</div>
            <div class="stat-value" id="min_max"></div>
          </div>
          <div class="stat">
            <div class="stat-label">Relojes analizados<span class="tooltip-icon" data-tip="N√∫mero de relojes de este modelo en el dataset">?</span></div>
            <div class="stat-value" id="relojes"></div>
          </div>
        </div>

        <div class="stats-row" style="margin-top:10px">
          <div class="stat">
            <div class="stat-label">Œî vs media (‚Ç¨/%)<span class="tooltip-icon" data-tip="Diferencia entre fair value y precio promedio del modelo">?</span></div>
            <div class="stat-value" id="diff_media"></div>
          </div>
          <div class="stat">
            <div class="stat-label">Elasticidad caja<span class="tooltip-icon" data-tip="Impacto porcentual de tener caja original">?</span></div>
            <div class="stat-value" id="elas_caja"></div>
          </div>
          <div class="stat">
            <div class="stat-label">Elasticidad papeles<span class="tooltip-icon" data-tip="Impacto porcentual de tener documentaci√≥n original">?</span></div>
            <div class="stat-value" id="elas_papeles"></div>
          </div>
        </div>

        <div class="subgrid">
          <div class="box">
            <h4>Price vs Year</h4>
            <canvas id="ch1"></canvas>
          </div>
          <div class="box">
            <h4>State Spread (‚Ç¨)</h4>
            <table id="tabla_estados">
              <thead>
                <tr>
                  <th>Estado</th>
                  <th>Precio</th>
                  <th>Œî vs actual</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="box" style="margin-top:12px">
          <h4>Quick Scenarios</h4>
          <table class="scenario-table" id="tabla_escenarios">
            <thead>
              <tr>
                <th>Escenario</th>
                <th>Precio</th>
                <th>Œî ‚Ç¨</th>
                <th>Œî %</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <p id="explicacion"></p>
      </div>

      <div id="placeholder" style="font-size:12px;color:#6b7280;">
        Introduce los datos del reloj en el panel izquierdo y ejecuta la valoraci√≥n para ver el panel de m√©tricas.
      </div>
    </div>
  </div>
</div>

<script>
window.onload = function () {
  

  let chartAno = null;
  let presentationMode = false;
  let comparisonData = null;
  let lastValuationData = null;
  let todosModelos = [];  // Mover aqu√≠

  // Datos de modelos ic√≥nicos
    const modelData = {
    'Rolex Submariner Date': 'üåä Icono de buceo profesional<br>‚Ä¢ Resistencia: 300m<br>‚Ä¢ Calibre: 3135/3235<br>‚Ä¢ Di√°metro: 40-41mm<br>‚Ä¢ Lanzamiento: 1969<br>‚Ä¢ Material bisel: Cerachrom cer√°mico',
    'Rolex Submariner': 'üåä Versi√≥n sin fecha del ic√≥nico diver<br>‚Ä¢ Resistencia: 300m<br>‚Ä¢ Calibre: 3130/3230<br>‚Ä¢ Di√°metro: 40-41mm<br>‚Ä¢ Lanzamiento: 1953<br>‚Ä¢ Ref. m√°s buscada: 114060, 124060',
    'Rolex Daytona': 'üèÅ Cron√≥grafo legendario de motorsport<br>‚Ä¢ Calibre: 4130<br>‚Ä¢ Di√°metro: 40mm<br>‚Ä¢ Lanzamiento: 1963<br>‚Ä¢ Taqu√≠metro en bisel<br>‚Ä¢ Asociado con Paul Newman',
    'Rolex GMT-Master II': '‚úàÔ∏è Icono de pilotos y viajeros<br>‚Ä¢ Doble zona horaria independiente<br>‚Ä¢ Calibre: 3186/3285<br>‚Ä¢ Di√°metro: 40mm<br>‚Ä¢ Bisel giratorio 24h<br>‚Ä¢ Lanzamiento GMT-Master: 1954',
    'Rolex Datejust': 'üëî El dress watch definitivo<br>‚Ä¢ Primera referencia con fecha (1945)<br>‚Ä¢ Calibre: 3135/3235<br>‚Ä¢ Di√°metros: 31, 36, 41mm<br>‚Ä¢ Bisel acanalado ic√≥nico<br>‚Ä¢ M√°s vers√°til de la marca',
    'Rolex Day-Date': 'üìÖ El reloj de los presidentes<br>‚Ä¢ D√≠a completo + fecha<br>‚Ä¢ Solo en metales preciosos<br>‚Ä¢ Calibre: 3255<br>‚Ä¢ Di√°metro: 36, 40mm<br>‚Ä¢ Lanzamiento: 1956',
    'Rolex Explorer': '‚õ∞Ô∏è Conquistador del Everest<br>‚Ä¢ Calibre: 3132/3230<br>‚Ä¢ Di√°metro: 36, 39mm<br>‚Ä¢ Lanzamiento: 1953<br>‚Ä¢ Esfera negra 3-6-9<br>‚Ä¢ M√°xima legibilidad',
    'Rolex Oyster Perpetual': '‚öôÔ∏è La esencia pura de Rolex<br>‚Ä¢ Sin fecha ni complicaciones<br>‚Ä¢ Calibre: 3230<br>‚Ä¢ Di√°metros: 28-41mm<br>‚Ä¢ M√∫ltiples colores disponibles<br>‚Ä¢ Entrada perfecta a la marca',
    'Rolex Sea-Dweller': 'üî± El hermano extremo del Submariner<br>‚Ä¢ Resistencia: 1220m (4000ft)<br>‚Ä¢ V√°lvula de helio<br>‚Ä¢ Calibre: 3235<br>‚Ä¢ Di√°metro: 43mm<br>‚Ä¢ Para buceo profesional',
    'Rolex Yacht-Master': '‚õµ Elegancia n√°utica<br>‚Ä¢ Bisel rotativo 60 min<br>‚Ä¢ Calibre: 3135/3235<br>‚Ä¢ Di√°metros: 37, 40, 42mm<br>‚Ä¢ Lanzamiento: 1992<br>‚Ä¢ Material bisel: Cerachrom o platino',
    'Rolex Cellini': 'üé© La l√≠nea dress cl√°sica<br>‚Ä¢ Sin Oyster case<br>‚Ä¢ Movimiento manual o autom√°tico<br>‚Ä¢ Inspiraci√≥n Art Deco<br>‚Ä¢ Di√°metros: 39mm t√≠pico<br>‚Ä¢ Elegancia atemporal',
    'Rolex Milgauss': '‚ö° El reloj antimagn√©tico<br>‚Ä¢ Resistencia: 1,000 gauss<br>‚Ä¢ Calibre: 3131<br>‚Ä¢ Di√°metro: 40mm<br>‚Ä¢ Aguja naranja rayo<br>‚Ä¢ Para cient√≠ficos e ingenieros',
    'Rolex Sky-Dweller': 'üåç La complicaci√≥n m√°s compleja<br>‚Ä¢ Calendario anual<br>‚Ä¢ Doble zona horaria<br>‚Ä¢ Calibre: 9001<br>‚Ä¢ Di√°metro: 42mm<br>‚Ä¢ Lanzamiento: 2012',
    'Rolex Air-King': 'üõ©Ô∏è Tributo a la aviaci√≥n<br>‚Ä¢ Calibre: 3230<br>‚Ä¢ Di√°metro: 40mm<br>‚Ä¢ Esfera negra distintiva<br>‚Ä¢ Escala de minutos destacada<br>‚Ä¢ Precio de entrada atractivo'
  };


  // Listener para cambio de modelo
  document.getElementById('modelo').addEventListener('change', function() {
    const modelo = this.value;
    const infoBox = document.getElementById('modelInfo');
    if (modelData[modelo]) {
      infoBox.style.display = 'block';
      infoBox.innerHTML = `<div class="model-info-title">MODEL INFO</div>${modelData[modelo]}`;
    } else {
      infoBox.style.display = 'none';
    }
   });

  // Toggle presentation mode
  document.getElementById('togglePresentation').addEventListener('click', function() {
    presentationMode = !presentationMode;
    document.getElementById('gridMain').classList.toggle('presentation-mode', presentationMode);
    this.textContent = presentationMode ? 'EXIT PRESENTATION' : 'PRESENTATION MODE';
  });

  async function cargarModelos() {
    try {
      const res = await fetch('/api/models');
      const data = await res.json();
      todosModelos = data.models;
      mostrarModelos(todosModelos);
      cargarHistorial();
    } catch (err) {
      console.error('Error cargando modelos', err);
    }
  }

  function mostrarModelos(modelos) {
    const select = document.getElementById('modelo');
    select.innerHTML = '';
    modelos.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      select.appendChild(opt);
    });
  }

  // Listener para b√∫squeda
  document.getElementById('modeloSearch').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    const filtrados = todosModelos.filter(m => m.toLowerCase().includes(query));
    mostrarModelos(filtrados);
  });

  function guardarEnHistorial(entry) {
    const key = 'horology_history';
    const existente = JSON.parse(localStorage.getItem(key) || '[]');
    existente.unshift(entry);
    const recortado = existente.slice(0, 8);
    localStorage.setItem(key, JSON.stringify(recortado));
  }

  function cargarHistorial() {
    const key = 'horology_history';
    const existente = JSON.parse(localStorage.getItem(key) || '[]');
    const tbody = document.querySelector('#tabla_historial tbody');
    tbody.innerHTML = '';
    existente.forEach(row => {
      const tr = document.createElement('tr');
      const diffSign = row.diff_media_pct >= 0 ? '+' : '‚àí';
      const diffText = `${diffSign}${Math.abs(row.diff_media_pct).toFixed(1)}%`;
      tr.innerHTML = `
        <td>${row.modelo}</td>
        <td>${row.anio}</td>
        <td>${row.estado}</td>
        <td>${row.fv.toLocaleString('es-ES')}‚Ç¨</td>
        <td>${diffText}</td>
      `;
      tbody.appendChild(tr);
    });
  }
      function mostrarComparacion(watch1, watch2) {
    const resultado = document.getElementById('resultado');
    
    const precioMasAlto = Math.max(watch1.precio, watch2.precio);
    
    // Mostrar ambos precios en el header con info de extras
    const precioEl = document.getElementById('precio');
    precioEl.style.display = 'flex';
    precioEl.style.justifyContent = 'center';
    precioEl.style.alignItems = 'center';
    precioEl.style.gap = '40px';
    precioEl.innerHTML = `
      <div style="text-align:center">
        <div style="font-size:11px;color:#9ca3af;margin-bottom:3px">${watch1.modelo} ${watch1.a√±o}</div>
        <div style="font-size:10px;color:#6b7280;margin-bottom:5px">${watch1.estado} ¬∑ ${watch1.material}</div>
        <span style="font-size:32px;font-weight:700;color:${watch1.precio === precioMasAlto ? '#4ade80' : '#f97373'}">${watch1.precio.toLocaleString('es-ES')}‚Ç¨</span>
        <div style="font-size:10px;color:#9ca3af;margin-top:3px">${watch1.caja ? '‚úì' : '‚úó'} Caja ¬∑ ${watch1.papeles ? '‚úì' : '‚úó'} Papeles</div>
      </div>
      <div style="color:#6b7280;font-size:20px">VS</div>
      <div style="text-align:center">
        <div style="font-size:11px;color:#9ca3af;margin-bottom:3px">${watch2.modelo} ${watch2.a√±o}</div>
        <div style="font-size:10px;color:#6b7280;margin-bottom:5px">${watch2.estado} ¬∑ ${watch2.material}</div>
        <span style="font-size:32px;font-weight:700;color:${watch2.precio === precioMasAlto ? '#4ade80' : '#f97373'}">${watch2.precio.toLocaleString('es-ES')}‚Ç¨</span>
        <div style="font-size:10px;color:#9ca3af;margin-top:3px">${watch2.caja ? '‚úì' : '‚úó'} Caja ¬∑ ${watch2.papeles ? '‚úì' : '‚úó'} Papeles</div>
      </div>
    `;
    
    // Actualizar rango para mostrar modelos claramente
    document.getElementById('rango').innerHTML = `
      <div style="font-size:10px;color:#9ca3af;text-align:right">
        <div style="color:#4ade80">${watch1.modelo} ${watch1.a√±o}</div>
        <div style="color:#f97373">${watch2.modelo} ${watch2.a√±o}</div>
      </div>
    `;
    
    // Stats primera fila - comparadas
    document.getElementById('base').innerHTML = `
      <div style="font-size:11px;color:#4ade80">${watch1.precio_base.toLocaleString('es-ES')}‚Ç¨</div>
      <div style="font-size:11px;color:#f97373">${watch2.precio_base.toLocaleString('es-ES')}‚Ç¨</div>
    `;
    
    document.getElementById('media_modelo').innerHTML = `
      <div style="font-size:11px;color:#4ade80">${watch1.stats.precio_promedio_modelo.toLocaleString('es-ES')}‚Ç¨</div>
      <div style="font-size:11px;color:#f97373">${watch2.stats.precio_promedio_modelo.toLocaleString('es-ES')}‚Ç¨</div>
    `;
    
    document.getElementById('min_max').textContent = 'Ver individual';
    
    document.getElementById('relojes').innerHTML = `
      <div style="font-size:11px;color:#4ade80">${watch1.stats.relojes_analizados}</div>
      <div style="font-size:11px;color:#f97373">${watch2.stats.relojes_analizados}</div>
    `;
    
    // Stats segunda fila - comparadas
    const diff1 = watch1.precio - watch1.stats.precio_promedio_modelo;
    const diff2 = watch2.precio - watch2.stats.precio_promedio_modelo;
    const pct1 = (diff1 / watch1.stats.precio_promedio_modelo * 100).toFixed(1);
    const pct2 = (diff2 / watch2.stats.precio_promedio_modelo * 100).toFixed(1);
    
    document.getElementById('diff_media').innerHTML = `
      <div style="font-size:11px;color:#4ade80">${diff1 >= 0 ? '+' : ''}${diff1.toLocaleString('es-ES')}‚Ç¨ (${pct1}%)</div>
      <div style="font-size:11px;color:#f97373">${diff2 >= 0 ? '+' : ''}${diff2.toLocaleString('es-ES')}‚Ç¨ (${pct2}%)</div>
    `;

    document.getElementById('elas_caja').innerHTML = `
      <div style="font-size:11px;color:#4ade80">${watch1.caja ? 'Con caja' : 'Sin caja'}</div>
      <div style="font-size:11px;color:#f97373">${watch2.caja ? 'Con caja' : 'Sin caja'}</div>
    `;
    
    document.getElementById('elas_papeles').innerHTML = `
      <div style="font-size:11px;color:#4ade80">${watch1.papeles ? 'Con papeles' : 'Sin papeles'}</div>
      <div style="font-size:11px;color:#f97373">${watch2.papeles ? 'Con papeles' : 'Sin papeles'}</div>
    `;
    
    // Cambiar bot√≥n a Clear
    const btnCompare = document.getElementById('btnCompare');
    btnCompare.textContent = '‚úï CLEAR COMPARISON';
    btnCompare.style.background = '#dc2626';
    btnCompare.onclick = function() {
    location.reload();
    };
    
    // Modificar gr√°fico para mostrar ambas l√≠neas
    if (chartAno) chartAno.destroy();
    
    const ctx1 = document.getElementById('ch1').getContext('2d');
    chartAno = new Chart(ctx1, {
      type: 'line',
      data: {
        labels: watch2.graficos_a√±o.map(p => p.a√±o),
        datasets: [{
          label: `${watch1.modelo} ${watch1.a√±o}`,
          data: watch1.graficos_a√±o.map(p => p.precio),
          borderColor: '#4ade80',
          backgroundColor: 'rgba(74,222,128,0.1)',
          borderWidth: 2,
          fill: false,
          tension: 0.35,
          pointRadius: 3
        }, {
          label: `${watch2.modelo} ${watch2.a√±o}`,
          data: watch2.graficos_a√±o.map(p => p.precio),
          borderColor: '#f97373',
          backgroundColor: 'rgba(249,115,115,0.1)',
          borderWidth: 2,
          fill: false,
          tension: 0.35,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: { enabled: true }
        },
        scales: {
          x: { title: { display: true, text: 'A√±o' }, grid: { color: 'rgba(31,41,55,0.6)' } },
          y: { title: { display: true, text: 'Precio (‚Ç¨)' }, grid: { color: 'rgba(31,41,55,0.6)' } }
        }
      }
    });
  }


  


  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
      modelo: document.getElementById('modelo').value,
      a√±o: parseInt(document.getElementById('anio').value),
      estado: document.getElementById('estado').value,
      material: document.getElementById('material').value,
      caja: document.getElementById('caja').checked,
      papeles: document.getElementById('papeles').checked,
    };

    const res = await fetch('/api/predict', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!data.success) {
      alert('Error: ' + data.error);
      return;
    }
  lastValuationData = data;  // Guardar data completa
    document.getElementById('placeholder').style.display = 'none';
    const resultado = document.getElementById('resultado');
    resultado.style.display = 'block';
resultado.style.animation = 'none';
setTimeout(() => { resultado.style.animation = 'fadeIn 0.5s ease forwards'; }, 10);


    // ticker
    const diffMedia = data.precio_estimado - data.stats.precio_promedio_modelo;
    const diffMediaPct = (diffMedia / data.stats.precio_promedio_modelo) * 100;
    const signTicker = diffMediaPct >= 0 ? '+' : '‚àí';
    document.getElementById('ticker').textContent =
      `MODEL: ${payload.modelo.toUpperCase()} | FAIR VALUE: ${data.precio_estimado.toLocaleString('es-ES')}‚Ç¨ | PREMIUM: ${signTicker}${Math.abs(diffMediaPct).toFixed(1)}% vs INDEX`;

    // Animaci√≥n contador para el precio (solo si NO hay comparaci√≥n)
if (!comparisonData) {
  const precioEl = document.getElementById('precio');
  const precioFinal = data.precio_estimado;
  let precioActual = 0;
  const duracion = 1000;
  const pasos = 30;
  const incremento = precioFinal / pasos;
  const intervalo = duracion / pasos;

  const timer = setInterval(() => {
    precioActual += incremento;
    if (precioActual >= precioFinal) {
      precioActual = precioFinal;
      clearInterval(timer);
    }
    precioEl.textContent = Math.round(precioActual).toLocaleString('es-ES') + ' ‚Ç¨';
  }, intervalo);
} else {
  // Si hay comparaci√≥n, poner precio directo sin animaci√≥n
  document.getElementById('precio').textContent = data.precio_estimado.toLocaleString('es-ES') + ' ‚Ç¨';
}



    document.getElementById('rango').textContent =
      `Rango modelo: ${data.rango.min.toLocaleString('es-ES')}‚Ç¨ ‚Äì ${data.rango.max.toLocaleString('es-ES')}‚Ç¨`;

    document.getElementById('base').textContent =
      data.precio_base.toLocaleString('es-ES') + ' ‚Ç¨';

    document.getElementById('media_modelo').textContent =
      data.stats.precio_promedio_modelo.toLocaleString('es-ES') + ' ‚Ç¨';

    document.getElementById('min_max').textContent =
      `${data.rango.min.toLocaleString('es-ES')}‚Ç¨ / ${data.rango.max.toLocaleString('es-ES')}‚Ç¨`;

    document.getElementById('relojes').textContent =
      data.stats.relojes_analizados.toLocaleString('es-ES');

    // Œî vs media y percentil
    const diffAbs = Math.abs(diffMedia);
    const sign = diffMedia >= 0 ? '+' : '‚àí';
    const diffPct = Math.abs(diffMediaPct);
    const diffEl = document.getElementById('diff_media');
    diffEl.textContent =
      `${sign}${diffAbs.toLocaleString('es-ES')} ‚Ç¨ (${sign}${diffPct.toFixed(1)}%)`;
    diffEl.className = 'stat-value ' + (diffMedia >= 0 ? 'green' : 'red');
    // elasticidades
    const base = data.precio_base || data.precio_estimado;
    const elasCaja = base ? (data.analisis_impacto.caja / base) * 100 : 0;
    const elasPap = base ? (data.analisis_impacto.papeles / base) * 100 : 0;
    document.getElementById('elas_caja').textContent =
      (isNaN(elasCaja) ? 0 : elasCaja).toFixed(1) + ' %';
    document.getElementById('elas_papeles').textContent =
      (isNaN(elasPap) ? 0 : elasPap).toFixed(1) + ' %';

    // tabla estados
    const tbodyEstados = document.querySelector('#tabla_estados tbody');
    tbodyEstados.innerHTML = '';
    data.graficos.por_estado.forEach(row => {
      const tr = document.createElement('tr');
      const diff = row.precio - data.precio_estimado;
      const s = diff >= 0 ? '+' : '‚àí';
      tr.innerHTML = `
        <td>${row.estado}</td>
        <td>${row.precio.toLocaleString('es-ES')}‚Ç¨</td>
        <td>${s}${Math.abs(diff).toLocaleString('es-ES')}‚Ç¨</td>
      `;
      tbodyEstados.appendChild(tr);
    });

    // escenarios r√°pidos (se calculan con el mismo modelo en frontend)
const tbodyEsc = document.querySelector('#tabla_escenarios tbody');
tbodyEsc.innerHTML = '';

function calcularPrecioEscenario(nombre, nuevoEstado, nuevaCaja, nuevosPapeles) {
  // tomamos los resultados de /api/predict como base
  // y reutilizamos los datos de graficos.por_estado
  let precioEsc = data.precio_estimado;

  // cambiar estado usando los precios por estado ya calculados
  if (nuevoEstado) {
    const filaEstado = data.graficos.por_estado.find(e => e.estado === nuevoEstado);
    if (filaEstado) {
      precioEsc = filaEstado.precio;
    }
  }

  // ajustar caja y papeles respecto al caso actual
  let ajusteExtras = 0;
  if (nuevaCaja !== undefined) {
    const deltaCaja = data.analisis_impacto.caja || 0;
    const tieneCajaActual = payload.caja;
    if (nuevaCaja && !tieneCajaActual) ajusteExtras += deltaCaja;
    if (!nuevaCaja && tieneCajaActual) ajusteExtras -= deltaCaja;
  }
  if (nuevosPapeles !== undefined) {
    const deltaPap = data.analisis_impacto.papeles || 0;
    const tienePapActual = payload.papeles;
    if (nuevosPapeles && !tienePapActual) ajusteExtras += deltaPap;
    if (!nuevosPapeles && tienePapActual) ajusteExtras -= deltaPap;
  }

  const precioFinal = precioEsc + ajusteExtras;
  const delta = precioFinal - data.precio_estimado;
  const deltaPct = (delta / data.precio_estimado) * 100;

  const signo = delta >= 0 ? '+' : '‚àí';
  const signoPct = deltaPct >= 0 ? '+' : '‚àí';

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${nombre}</td>
    <td>${precioFinal.toLocaleString('es-ES')}‚Ç¨</td>
    <td>${signo}${Math.abs(delta).toLocaleString('es-ES')}‚Ç¨</td>
    <td>${signoPct}${Math.abs(deltaPct).toFixed(1)}%</td>
  `;
  tbodyEsc.appendChild(tr);
}

// escenarios que mostramos
calcularPrecioEscenario('Downgrade estado', 'Good');
calcularPrecioEscenario('Upgrade estado', 'Unworn');
calcularPrecioEscenario('Sin caja', null, false, undefined);
calcularPrecioEscenario('Sin papeles', null, undefined, false);


    // explicaci√≥n
    let frase;
    const media = data.stats.precio_promedio_modelo;
    if (Math.abs(diffMedia) < media * 0.05) {
      frase = 'El reloj cotiza muy cerca del promedio hist√≥rico del modelo: movimiento alineado con mercado secundario.';
    } else if (diffMedia > 0) {
      frase = 'La valoraci√≥n se sit√∫a por encima de la media, indicando una unidad por encima del est√°ndar (estado, configuraci√≥n o extras atractivos).';
    } else {
      frase = 'La valoraci√≥n se sit√∫a por debajo de la media, posiblemente por desgaste, antig√ºedad o ausencia de caja/papeles.';
    }
    document.getElementById('explicacion').textContent = frase;

    // gr√°fico por a√±o
    const labelsAno = data.graficos.por_a√±o.map(p => p.a√±o);
    const valoresAno = data.graficos.por_a√±o.map(p => p.precio);

    if (chartAno) chartAno.destroy();

    const ctx1 = document.getElementById('ch1').getContext('2d');
    chartAno = new Chart(ctx1, {
      type: 'line',
      data: {
        labels: labelsAno,
        datasets: [{
          label:'Fair value (‚Ç¨)',
          data: valoresAno,
          borderColor:'#22c55e',
          backgroundColor:'rgba(34,197,94,0.12)',
          borderWidth:2,
          fill:true,
          tension:0.35,
          pointRadius:3,
          pointBackgroundColor:'#22c55e'
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{display:false},
          tooltip:{enabled:true}
        },
        scales:{
          x:{
            title:{display:true,text:'A√±o'},
            grid:{color:'rgba(31,41,55,0.6)'}
          },
          y:{
            title:{display:true,text:'Precio (‚Ç¨)'},
            grid:{color:'rgba(31,41,55,0.6)'}
          }
        }
      }
    });

    // guardar en historial
    guardarEnHistorial({
      modelo: payload.modelo,
      anio: payload.a√±o,
      estado: payload.estado,
      fv: data.precio_estimado,
      diff_media_pct: diffMediaPct
    });
        cargarHistorial();
    
    // Si hay comparaci√≥n activa, mostrar lado a lado
        if (comparisonData) {
      mostrarComparacion(comparisonData, {
        modelo: payload.modelo,
        a√±o: payload.a√±o,
        estado: payload.estado,
        material: payload.material,
        caja: payload.caja,
        papeles: payload.papeles,
        precio: data.precio_estimado,
        precio_base: data.precio_base,
        stats: data.stats,
        graficos_a√±o: data.graficos['por_a√±o']
      });
    }
  });

  // Listener del bot√≥n de comparaci√≥n
document.getElementById('btnCompare').addEventListener('click', function() {
  if (!lastValuationData) return;
  
     comparisonData = {
    modelo: document.getElementById('modelo').value,
    a√±o: parseInt(document.getElementById('anio').value),
    estado: document.getElementById('estado').value,
    material: document.getElementById('material').value,
    caja: document.getElementById('caja').checked,
    papeles: document.getElementById('papeles').checked,
    precio: lastValuationData.precio_estimado,
    precio_base: lastValuationData.precio_base,
    stats: lastValuationData.stats,
    graficos_a√±o: lastValuationData.graficos['por_a√±o']
  };

  
  this.textContent = '‚úì SAVED - Value another watch';
  this.style.background = '#374151';
  setTimeout(() => {
    this.textContent = '+ ADD TO COMPARISON';
    this.style.background = 'linear-gradient(90deg,#22c55e,#16a34a)';
  }, 2000);
});

// Listener del bot√≥n Copy
document.getElementById('btnCopy').addEventListener('click', function() {
  if (!lastValuationData) return;
  
  const modelo = document.getElementById('modelo').value;
  const a√±o = document.getElementById('anio').value;
  const estado = document.getElementById('estado').value;
  const material = document.getElementById('material').value;
  const caja = document.getElementById('caja').checked ? '‚úì' : '‚úó';
  const papeles = document.getElementById('papeles').checked ? '‚úì' : '‚úó';
  
  const texto = `
üïê HOROLOGY.IA - Valoraci√≥n

Modelo: ${modelo}
A√±o: ${a√±o}
Estado: ${estado}
Material: ${material}
Caja: ${caja} | Papeles: ${papeles}

üí∞ FAIR VALUE: ${lastValuationData.precio_estimado.toLocaleString('es-ES')}‚Ç¨

üìä Stats:
‚Ä¢ Precio base: ${lastValuationData.precio_base.toLocaleString('es-ES')}‚Ç¨
‚Ä¢ Media modelo: ${lastValuationData.stats.precio_promedio_modelo.toLocaleString('es-ES')}‚Ç¨
‚Ä¢ Rango: ${lastValuationData.rango.min.toLocaleString('es-ES')}‚Ç¨ - ${lastValuationData.rango.max.toLocaleString('es-ES')}‚Ç¨
‚Ä¢ Relojes analizados: ${lastValuationData.stats.relojes_analizados}
  `;
  
  navigator.clipboard.writeText(texto.trim()).then(() => {
    this.textContent = '‚úì COPIED!';
    this.style.background = '#16a34a';
    setTimeout(() => {
      this.textContent = 'üìã COPY RESULTS';
      this.style.background = '#2563eb';
    }, 2000);
  });
});

    cargarModelos();
};

</script>
</body>
</html>